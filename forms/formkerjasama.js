// Document template
const documentTemplate = `PERJANJIAN KERJASAMA

Perjanjian kerjasama ini (untuk selanjutnya disebut "Perjanjian") ditandatangani dan dilangsungkan di {{tempat_penandatanganan}}, pada hari {{hari}}, tanggal {{tanggal}} bulan {{bulan}} tahun {{tahun}}, oleh dan antara:

{{nama_pihak_pertama}}, pemilik KTP dengan nomor {{ktp_pihak_pertama}} bertempat tinggal permanen di {{alamat_pihak_pertama}}, untuk selanjutnya disebut "Pihak Pertama"; dan

{{nama_pihak_kedua}}, pemilik KTP dengan nomor {{ktp_pihak_kedua}} bertempat tinggal permanen di {{alamat_pihak_kedua}}, untuk selanjutnya disebut "Pihak Kedua",

secara bersama-sama disebut sebagai PARA PIHAK.

Pemberi Waralaba dan Penerima Waralaba dengan ini terlebih dahulu menerangkan hal-hal sebagai berikut:

Bahwa Pemberi Waralaba adalah suatu badan usaha yang menjalankan usaha di bidang {{kegiatan_usaha}}, dan memiliki hak atas merek dagang, sistem operasional, serta pengetahuan teknis yang telah terbukti keberhasilannya, digunakan dalam kegiatan usahanya dan telah mematuhi peraturan yang berlaku.

Bahwa Penerima Waralaba adalah pihak yang berminat dan memenuhi syarat untuk menjalankan usaha waralaba dari Pemberi Waralaba, dan bersedia mengikuti seluruh ketentuan, standar, dan sistem yang ditetapkan oleh Pemberi Waralaba.

Para Pihak bermaksud untuk mengatur hak dan kewajiban masing-masing dalam hubungan waralaba ini melalui Perjanjian ini.

Maka dengan ini, Para Pihak sepakat untuk membuat dan menandatangani Perjanjian Waralaba ini dengan syarat dan ketentuan sebagai berikut:

PASAL 1
DEFINISI

"Biaya Royalti" berarti pembayaran berkala yang wajib dibayarkan oleh Penerima Waralaba kepada Pemberi Waralaba atas penggunaan sistem dan dukungan berkelanjutan.
"Biaya Waralaba" berarti biaya awal yang dibayarkan oleh Penerima Waralaba kepada Pemberi Waralaba atas pemberian hak waralaba.
"Hak Kekayaan Intelektual" berarti seluruh hak atas merek dagang, nama dagang, logo, desain, rahasia dagang, dan hak kekayaan intelektual lainnya yang dimiliki atau dilisensikan oleh Pemberi Waralaba.
"Hari Kerja" adalah hari selain hari Sabtu, Minggu dan hari libur nasional yang ditetapkan oleh Pemerintah Republik Indonesia.
"Waralaba" berarti hak khusus yang dimiliki oleh badan usaha terhadap sistem bisnis dengan ciri khas usaha dalam rangka memasarkan barang dan/atau jasa yang telah terbukti berhasil dan dapat dimanfaatkan dan/atau digunakan oleh pihak lain berdasarkan Perjanjian Waralaba.

PASAL 2
RUANG LINGKUP PERJANJIAN

Pemberi Waralaba memberikan hak kepada Penerima Waralaba untuk menggunakan merek dagang dan sistem usaha Pemberi Waralaba dalam menjalankan usaha di bidang {{kegiatan_usaha}}.

Penerima Waralaba akan menjalankan usaha di lokasi yang telah disetujui oleh Pemberi Waralaba, yaitu di {{lokasi}}, kecuali terdapat kesepakatan di kemudian hari yang harus diatur dalam suatu perjanjian tambahan mengenai perluasan jaringan.

Para Pihak menyepakati bahwa objek dari perjanjian ini berbentuk sistem bisnis kerjasama berlisensi dan pengembangan usaha berupa program bisnis/usaha berlisensi yang diperjualbelikan dengan menggunakan metode waralaba/franchise, yang merupakan hak milik dari Pemberi Waralaba.

Perjanjian ini mencakup pengoperasian {{jumlah_gerai}} gerai, kecuali disetujui lain secara tertulis oleh Pemberi Waralaba.

Perjanjian ini berlaku untuk wilayah {{wilayah_usaha}}.

Hak yang diberikan kepada Penerima Waralaba bersifat {{sifat_hak}} selama masa berlakunya Perjanjian ini.

PASAL 3
HAK DAN JAMINAN PEMBERI WARALABA

Pemberi Waralaba memberikan lisensi kepada Penerima Waralaba untuk menggunakan merek dagang, logo, dan sistem usaha milik Pemberi Waralaba.

Pemberi Waralaba wajib menyediakan dukungan berkesinambungan seperti pelatihan awal mengenai manajemen usaha, kegiatan pemasaran, memberikan bimbingan manajemen operasional, dukungan penelitian produk yang dipasarkan, dan bimbingan pengembangan pasar dan bentuk pembinaan lainnya kepada Penerima Waralaba dan/atau penerima waralaba lanjutan (jika ada).

Pemberi Waralaba wajib menyediakan sistem usaha Waralaba dan memperbaharui dan/atau memperbaikinya jika diperlukan.

Pemberi Waralaba berhak untuk menerima imbalan, berupa Biaya Awal dan Biaya Royalti, baik dari Penerima Waralaba dan/atau penerima waralaba lanjutan (jika ada) atas penggunaan sistem bisnis dan kekayaan intelektual milik Pemberi Waralaba sesuai dengan ketentuan Perjanjian ini.

Pemberi Waralaba wajib untuk memberikan jaminan apabila Pemberi Waralaba menghentikan kegiatan usahanya, maka Penerima Waralaba dan/atau penerima waralaba lanjutan (jika ada) berhak memperoleh kompensasi sesuai dengan kesepakatan tertulis.

Pemberi Waralaba wajib memberikan dukungan yang berkesinambungan kepada Penerima Waralaba dan/atau penerima waralaba lanjutan berupa pelatihan lanjutan, pendampingan, dan pengawasan atas pelaksanaan standar operasional.

PASAL 4
HAK DAN JAMINAN PENERIMA WARALABA

Penerima Waralaba berhak menggunakan kekayaan intelektual milik Pemberi Waralaba sesuai ketentuan dalam Perjanjian ini.

Penerima Waralaba wajib untuk menjalankan usaha sesuai dengan seluruh standar yang telah ditetapkan oleh Pemberi Waralaba.

Penerima Waralaba wajib menjalankan usaha di lokasi yang telah diajukan oleh Penerima Waralaba dan telah disetujui oleh Pemberi Waralaba.

Penerima Waralaba wajib membayar Biaya Waralaba dan Biaya Royalti tepat waktu sesuai dengan Perjanjian ini.

Penerima Waralaba wajib menjaga kode etik dan kerahasiaan atas kekayaan intelektual milik Pemberi Waralaba.

Penerima Waralaba wajib menjaga kerahasiaan seluruh informasi bisnis yang diperoleh dari Pemberi Waralaba baik selama maupun setelah berlakunya Perjanjian.

Penerima Waralaba tidak diperbolehkan melakukan perubahan terhadap sistem usaha tanpa persetujuan tertulis dari Pemberi Waralaba.

Penerima Waralaba tidak diperbolehkan untuk mengalihkan, menjual atau memindahtangankan seluruh atau sebagian hak dan/atau kewajiban berdasarkan Perjanjian ini kepada pihak ketiga tanpa persetujuan tertulis dari Pemberi Waralaba.

Apabila ayat (8) disetujui oleh Pemberi Waralaba, maka Penerima Waralaba dapat memberikan hak waralaba kepada pihak ketiga (waralaba lanjutan) dengan kewajiban memastikan bahwa pihak ketiga tersebut tunduk pada ketentuan Perjanjian ini.

PASAL 5
SISTEM BISNIS

Pemberi Waralaba menyatakan bahwa sistem bisnis Waralaba yang dimiliki telah terbukti berhasil dan menjadi ciri khas usaha, yang meliputi:

Konsep dan modal usaha

Standar operasional prosedur yang mencakup layanan pelanggan, standar mutu, kebersihan dan keamanan

Sistem pelatihan awal dan lanjutan untuk karyawan dan/atau manajemen

Sistem pengelolaan keuangan

Sistem pemasaran dan promosi

Sistem bisnis sebagaimana dimaksud pada ayat (1) telah disusun dan dikembangkan sesuai dengan peraturan perundang-undangan yang berlaku.

Penerima Waralaba wajib menjalankan usaha berdasarkan sistem bisnis sebagaimana dimaksud pada ayat (1), serta tunduk dan patuh terhadap ketentuan maupun standar yang diberikan oleh Pemberi Waralaba.

Pemberi Waralaba berhak melakukan pembaruan, penyesuaian, atau pengembangan terhadap sistem bisnis dengan pemberitahuan tertulis kepada Penerima Waralaba. Penerima Waralaba wajib menyesuaikan kegiatan operasionalnya sesuai dengan perubahan yang telah diberitahukan tersebut dalam jangka waktu paling lambat {{jangka_waktu_pembaruan}} Hari Kerja.

PASAL 6
PEMBAYARAN

Penerima Waralaba wajib membayar Biaya Awal sebesar {{biaya_awal}} sebelum penandatanganan Perjanjian ini.

Penerima Waralaba wajib membayar Biaya Royalti sebesar {{biaya_royalti}} dari omzet bulanan, dibayarkan selambat-lambatnya tanggal 10 setiap bulan.

Pembayaran atas kewajiban Penerima Waralaba dapat dilakukan dengan menggunakan sistem transfer bank melalui {{bank_rekening}}.

PASAL 7
JANGKA WAKTU

Perjanjian ini berlaku selama {{jumlah_tahun}} tahun terhitung sejak tanggal {{tanggal_mulai}} sampai {{tanggal_akhir}}.

PASAL 8
HAK KEKAYAAN INTELEKTUAL

Pemberi Waralaba menjamin tetap menjadi pemilik sah seluruh Hak Kekayaan Intelektual, termasuk namun tidak terbatas pada merek, nama, dan logo usaha.

Penerima Waralaba hanya berhak menggunakan Hak Kekayaan Intelektual tersebut selama masa berlakunya Perjanjian ini.

Penerima Waralaba tidak diperbolehkan mendaftarkan atau mengalihkan Hak Kekayaan Intelektual atas namanya sendiri.

PASAL 9
PERSAINGAN

Penerima Waralaba tidak diperkenankan membuka atau terlibat dalam usaha sejenis selama masa berlakunya Perjanjian dan selama 1 (satu) tahun setelah berakhirnya Perjanjian.

PASAL 10
KEPEMILIKAN DAN PERALIHAN HAK WARALABA

Kepemilikan atas hak Waralaba tetap berada pada Pemberi Waralaba.

Setiap peralihan hak atau pemberian waralaba lanjutan kepada pihak ketiga oleh Pemberi Waralaba hanya dapat dilakukan dengan persetujuan tertulis dari Pemberi Waralaba.

Pemberi waralaba lanjutan wajib tunduk pada seluruh ketentuan yang diatur dalam Perjanjian ini dan perjanjian terpisah jika diperlukan.

PASAL 11
TATA CARA PERPANJANGAN DAN PENGAKHIRAN

Perjanjian ini dapat diperpanjang atas kesepakatan Para Pihak secara tertulis dengan melakukan evaluasi terhadap kinerja Penerima Waralaba.

Perpanjangan Perjanjian ini paling lambat dapat dilakukan dalam jangka waktu 60 (enam puluh) Hari Kerja sebelum berakhirnya jangka waktu Perjanjian, Penerima Waralaba dapat mengajukan permohonan perpanjangan Perjanjian kepada Pemberi Waralaba secara tertulis.

Perjanjian ini dapat diakhiri sebelum jangka waktu berakhir apabila:

Penerima Waralaba tidak memenuhi target kinerja usaha atau standar operasional yang telah ditetapkan oleh Pemberi Waralaba selama periode evaluasi berturut-turut selama {{jumlah_evaluasi}}.

Terjadi tindakan penipuan, pelanggaran hukum, atau kegiatan usaha ilegal yang dilakukan oleh salah satu Pihak sehubungan dengan pelaksanaan Perjanjian ini.

Salah satu Pihak dinyatakan pailit, dalam likuidasi, atau berada dalam pengawasan kurator.

Para Pihak sepakat secara tertulis untuk mengakhiri Perjanjian sebelum jangka waktu berakhir.

Terdapat perubahan pengendalian atau kepemilikan atas salah satu Pihak tanpa persetujuan tertulis dari Pihak lainnya.

Penerima Waralaba gagal membayar Biaya Awal dan/atau Biaya Royalti lebih dari {{jangka_waktu_kegagalan_bayar}} berturut-turut setelah menerima teguran tertulis dari Pemberi Waralaba sebanyak {{jumlah_teguran}}.

Penerima Waralaba mengubah sistem usaha tanpa persetujuan tertulis dari Pemberi Waralaba.

Penerima Waralaba melanggar ketentuan mengenai penggunaan dan/atau kerahasiaan Hak Kekayaan Intelektual Pemberi Waralaba.

Salah satu Pihak lalai menjalankan kewajiban-kewajiban utama yang secara substansial mempengaruhi kelangsungan hubungan waralaba, dan tidak melakukan perbaikan dalam waktu {{jangka_waktu_kelalaian}}.

Dalam hal Perjanjian diakhiri lebih awal berdasarkan ketentuan pada Pasal 11 ayat (3), maka seluruh hak dan kewajiban yang telah timbul sebelum tanggal efektif pengakhiran tetap harus diselesaikan sesuai dengan ketentuan Perjanjian ini.

PASAL 12
FORCE MAJEURE

Dalam hal terjadi keadaan atau peristiwa yang berada di luar kendali dan tidak dapat diperkirakan secara wajar oleh Para Pihak pada saat penandatanganan Perjanjian ini, yang menyebabkan salah satu atau kedua belah pihak tidak dapat melaksanakan sebagian atau seluruh kewajiban berdasarkan Perjanjian ini, maka keadaan tersebut dianggap sebagai force majeure.

Keadaan force majeure sebagaimana disebutkan pada Pasal 12 ayat (1) meliputi, namun tidak terbatas pada, bencana alam seperti gempa bumi, banjir, angin topan, kebakaran, wabah, perang, serta kebijakan atau peraturan pemerintah yang mengakibatkan kegiatan usaha tidak dapat dilaksanakan.

Pihak yang terdampak dari force majeure wajib memberitahukan secara tertulis kepada Pihak lainnya dalam jangka waktu paling lambat 7 (tujuh) Hari Kerja sejak terjadinya kejadian force majeure, disertai dengan penjelasan mengenai sifat dan perkiraan durasi kejadian tersebut.

Para Pihak tetap berkewajiban untuk mengambil langkah-langkah yang wajar guna memitigasi dampak dari force majeure dan menjaga komunikasi secara terbuka terkait perkembangan keadaan tersebut.

Apabila keadaan force majeure berlangsung secara terus-menerus selama lebih dari 90 (sembilan puluh) Hari Kerja, maka Para Pihak akan melakukan perundingan untuk menentukan langkah lebih lanjut, termasuk namun tidak terbatas pada pengakhiran Perjanjian ini secara musyawarah mufakat.

Keadaan force majeure tidak membebaskan Penerima Waralaba dari kewajiban untuk menyelesaikan kewajiban yang harus dilakukan atau telah jatuh tempo sebelum terjadinya force majeure, kecuali disepakati lain oleh Para Pihak secara tertulis.

PASAL 13
PENYELESAIAN SENGKETA

Para Pihak sepakat untuk menyelesaikan setiap sengketa, perselisihan, atau perbedaan pendapat yang timbul sehubungan dengan pelaksanaan Perjanjian ini terlebih dahulu melalui musyawarah untuk mufakat dalam waktu paling lambat 30 (tiga puluh) Hari Kerja sejak terjadinya sengketa.

Apabila setelah 30 (tiga puluh) Hari Kerja Para Pihak belum mencapai kesepakatan, maka Para Pihak sepakat untuk menyelesaikan sengketa melalui {{forum_penyelesaian_sengketa}}.

PASAL 14
KETENTUAN PENUTUP

Hal-hal yang belum diatur atau belum cukup diatur dalam Perjanjian ini apabila dikemudian hari dibutuhkan dan dianggap perlu akan ditetapkan tersendiri secara musyawarah dan selanjutnya akan ditetapkan dalam suatu adendum yang disepakati oleh Para Pihak, yang merupakan bagian yang tidak terpisahkan dari Perjanjian ini.

Demikianlah Perjanjian ini dibuat dalam rangkap 2 (dua), untuk masing-masing pihak, yang ditandatangani di atas kertas bermaterai cukup, yang masing-masing mempunyai kekuatan hukum yang sama dan berlaku sejak ditandatangani.`;

// Variables mapping from form to template
const variableMapping = {
  'tempat_penandatanganan': 'tempat_penandatanganan',
  'hari': 'hari',
  'tanggal': 'tanggal',
  'bulan': 'bulan',
  'tahun': 'tahun',
  'nama_pihak_pertama': 'nama_pihak_pertama',
  'ktp_pihak_pertama': 'ktp_pihak_pertama',
  'alamat_pihak_pertama': 'alamat_pihak_pertama',
  'nama_pihak_kedua': 'nama_pihak_kedua',
  'ktp_pihak_kedua': 'ktp_pihak_kedua',
  'alamat_pihak_kedua': 'alamat_pihak_kedua',
  'kegiatan_usaha': 'kegiatan_usaha',
  'lokasi': 'lokasi',
  'jumlah_gerai': 'jumlah_gerai',
  'wilayah_usaha': 'wilayah_usaha',
  'sifat_hak': 'sifat_hak',
  'biaya_awal': 'biaya_awal',
  'biaya_royalti': 'biaya_royalti',
  'bank_rekening': 'bank_rekening',
  'jumlah_tahun': 'jumlah_tahun',
  'tanggal_mulai': 'tanggal_mulai',
  'tanggal_akhir': 'tanggal_akhir',
  'jangka_waktu_pembaruan': 'jangka_waktu_pembaruan',
  'jumlah_evaluasi': 'jumlah_evaluasi',
  'jangka_waktu_kegagalan_bayar': 'jangka_waktu_kegagalan_bayar',
  'jumlah_teguran': 'jumlah_teguran',
  'jangka_waktu_kelalaian': 'jangka_waktu_kelalaian',
  'forum_penyelesaian_sengketa': 'forum_penyelesaian_sengketa'
};

// Format date to Indonesian format
function formatDate(dateString) {
  if (!dateString) return '';
  const date = new Date(dateString);
  const day = date.getDate();
  const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
  const month = months[date.getMonth()];
  const year = date.getFullYear();
  return `${day} ${month} ${year}`;
}

// Replace variables in template
function replaceVariables(template, formData) {
  let result = template;
  
  // Replace all variables - use placeholder if empty with background color for Word
  Object.keys(variableMapping).forEach(key => {
    const value = formData[key] || '';
    const placeholder = `{{${variableMapping[key]}}}`;
    // If value is empty, use placeholder with simple background that Word can render
    const replacement = value || `<mark style="background-color: #fffbe6; color: #000; padding: 2px 4px;">[${key.replace(/_/g, ' ')}]</mark>`;
    result = result.replace(new RegExp(placeholder, 'g'), replacement);
  });
  
  // Format dates - use placeholder if empty with background color for Word
  if (formData.tanggal_mulai) {
    result = result.replace(/{{tanggal_mulai}}/g, formatDate(formData.tanggal_mulai));
  } else {
    result = result.replace(/{{tanggal_mulai}}/g, '<mark style="background-color: #fffbe6; color: #000; padding: 2px 4px;">[Tanggal Mulai]</mark>');
  }
  if (formData.tanggal_akhir) {
    result = result.replace(/{{tanggal_akhir}}/g, formatDate(formData.tanggal_akhir));
  } else {
    result = result.replace(/{{tanggal_akhir}}/g, '<mark style="background-color: #fffbe6; color: #000; padding: 2px 4px;">[Tanggal Akhir]</mark>');
  }
  
  return result;
}

// Map form fields to preview sections
const fieldToSectionMap = {
  'tempat_penandatanganan': 'section-0',
  'hari': 'section-0',
  'tanggal': 'section-0',
  'bulan': 'section-0',
  'tahun': 'section-0',
  'nama_pihak_pertama': 'section-1',
  'ktp_pihak_pertama': 'section-1',
  'alamat_pihak_pertama': 'section-1',
  'nama_pihak_kedua': 'section-2',
  'ktp_pihak_kedua': 'section-2',
  'alamat_pihak_kedua': 'section-2',
  'kegiatan_usaha': 'section-3',
  'lokasi': 'section-4',
  'jumlah_gerai': 'section-4',
  'wilayah_usaha': 'section-4',
  'sifat_hak': 'section-4',
  'jangka_waktu_pembaruan': 'section-5',
  'biaya_awal': 'section-6',
  'biaya_royalti': 'section-6',
  'bank_rekening': 'section-6',
  'jumlah_tahun': 'section-7',
  'tanggal_mulai': 'section-7',
  'tanggal_akhir': 'section-7',
  'jumlah_evaluasi': 'section-8',
  'jangka_waktu_kegagalan_bayar': 'section-8',
  'jumlah_teguran': 'section-8',
  'jangka_waktu_kelalaian': 'section-8',
  'forum_penyelesaian_sengketa': 'section-9'
};

// Scroll to preview section when form field is focused
function scrollToPreviewSection(fieldName) {
  const sectionId = fieldToSectionMap[fieldName];
  if (!sectionId) return;
  
  const previewSection = document.getElementById(sectionId);
  if (previewSection) {
    previewSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
    previewSection.classList.add('preview-section--active');
    setTimeout(() => {
      previewSection.classList.remove('preview-section--active');
    }, 2000);
  }
}

// Generate preview HTML with blur effect
function generatePreview(formData) {
  const preview = document.getElementById('documentPreview');
  if (!preview) return;
  
  const template = documentTemplate;
  const sections = template.split(/\n\n+/);
  
  let html = '<div class="preview-document-content">';
  let sectionIndex = 0;
  
  sections.forEach((section, index) => {
    const hasVariable = /{{[^}]+}}/.test(section);
    
    if (hasVariable) {
      // Section with variables - show with placeholders
      let sectionHtml = section;
      const sectionId = `section-${sectionIndex}`;
      
      // Replace variables with form data or show placeholder
      Object.keys(variableMapping).forEach(key => {
        const value = formData[key] || '';
        const placeholder = `{{${variableMapping[key]}}}`;
        if (value) {
          sectionHtml = sectionHtml.replace(new RegExp(placeholder, 'g'), `<span class="filled-field">${value}</span>`);
        } else {
          sectionHtml = sectionHtml.replace(new RegExp(placeholder, 'g'), `<span class="placeholder-field">[${key.replace(/_/g, ' ')}]</span>`);
        }
      });
      
      // Format dates
      if (formData.tanggal_mulai) {
        sectionHtml = sectionHtml.replace(/{{tanggal_mulai}}/g, `<span class="filled-field">${formatDate(formData.tanggal_mulai)}</span>`);
      }
      if (formData.tanggal_akhir) {
        sectionHtml = sectionHtml.replace(/{{tanggal_akhir}}/g, `<span class="filled-field">${formatDate(formData.tanggal_akhir)}</span>`);
      }
      
      sectionHtml = sectionHtml.replace(/\n/g, '<br>');
      html += `<div id="${sectionId}" class="preview-section preview-section--has-variable">${sectionHtml}</div>`;
      sectionIndex++;
    } else {
      // Section without variables - blur it
      const blurredText = section.replace(/\n/g, '<br>');
      html += `<div class="preview-section preview-section--blurred">${blurredText}</div>`;
    }
  });
  
  html += '</div>';
  preview.innerHTML = html;
}

// Collect form data
function collectFormData() {
  const form = document.getElementById('documentForm');
  const formData = new FormData(form);
  const data = {};
  
  // Get all form values
  formData.forEach((value, key) => {
    data[key] = value;
  });
  
  return data;
}

// Calculate and update progress
function updateProgress() {
  const formData = collectFormData();
  const form = document.getElementById('documentForm');
  const allFields = form.querySelectorAll('input[type="text"], input[type="number"], input[type="date"], textarea, select');
  
  let filledCount = 0;
  let totalFields = 0;
  
  allFields.forEach(field => {
    totalFields++;
    if (field.value && field.value.trim() !== '') {
      filledCount++;
    }
  });
  
  const percentage = totalFields > 0 ? Math.round((filledCount / totalFields) * 100) : 0;
  
  // Update progress bar
  const progressBarFill = document.getElementById('progressBarFill');
  const progressPercentage = document.getElementById('progressPercentage');
  
  if (progressBarFill) {
    progressBarFill.style.width = `${percentage}%`;
  }
  
  if (progressPercentage) {
    progressPercentage.textContent = `${percentage}%`;
  }
}

// Helper function to bold text within quotation marks (excluding HTML attributes)
function boldQuotedText(text) {
  // First, protect HTML tags and attributes by replacing them temporarily
  const htmlPlaceholders = [];
  let protectedText = text.replace(/<[^>]+>/g, (match) => {
    const index = htmlPlaceholders.length;
    htmlPlaceholders.push(match);
    return `__HTML_PLACEHOLDER_${index}__`;
  });
  
  // Now apply bold to quoted text
  protectedText = protectedText.replace(/"([^"]+)"/g, '<strong>"$1"</strong>');
  
  // Restore HTML tags
  htmlPlaceholders.forEach((html, index) => {
    protectedText = protectedText.replace(`__HTML_PLACEHOLDER_${index}__`, html);
  });
  
  return protectedText;
}

// Generate Word document using HTML to Word conversion
function generateWordDocument(formData) {
  const fullDocument = replaceVariables(documentTemplate, formData);
  const sections = fullDocument.split('\n\n');
  
  // Separate title from content
  let titleSection = '';
  let contentSections = [];
  let foundTitle = false;
  
  sections.forEach(para => {
    if (!foundTitle && para.trim().includes('PERJANJIAN')) {
      titleSection = para.trim();
      foundTitle = true;
    } else if (foundTitle) {
      contentSections.push(para);
    }
  });
  
  // Create HTML content for Word document
  const htmlContent = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <style>
        :root {
          --page-width: 800px;
          --page-padding: 48px;
          --radius: 10px;
          --border: 1px solid rgba(0,0,0,.08);
          --shadow: 0 10px 30px rgba(0,0,0,.08);
          --text: #1d1d1f;
          --muted: #6b7280;
        }
        
        * { box-sizing: border-box; }
        
        html, body { height: 100%; }
        
        body {
          margin: 0;
          font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
          line-height: 1.65;
          color: var(--text);
          background: transparent;
          display: flex;
          justify-content: center;
          padding: 40px 16px;
        }
        
        .doc {
          width: 100%;
          max-width: var(--page-width);
          background: #fff;
          border: var(--border);
          border-radius: var(--radius);
          box-shadow: var(--shadow);
          padding: var(--page-padding);
        }
        
        h1, h2, h3 {
          margin: 0 0 14px 0;
          font-weight: 650;
          letter-spacing: .2px;
          text-align: center;
        }
        
        h1 { 
          font-size: 26px; 
          text-transform: uppercase;
          page-break-after: always;
        }
        
        h2 { 
          font-size: 18px; 
          padding-top: 12px; 
          border-top: 1px solid #eee;
          page-break-after: avoid;
        }
        
        h3 { font-size: 16px; color: var(--muted); text-transform: uppercase; }
        
        p { 
          margin: 10px 0;
          text-align: justify;
        }
        
        .spacer { height: 10px; }
        
        hr { border: none; border-top: 1px solid #eee; margin: 20px 0; }
        
        .note { color: var(--muted); font-size: 13px; }
        
        .placeholder { 
          background: #fffbe6; 
          border: 1px dashed #f1c40f; 
          padding: 2px 4px; 
          border-radius: 4px; 
        }
        
        strong { font-weight: 700; }
        
        mark {
          background-color: #fffbe6;
          color: #000;
          padding: 2px 4px;
          border-radius: 3px;
        }
      </style>
    </head>
    <body>
      <div class="doc">
        <!-- Title Page -->
        <h1>${boldQuotedText(titleSection)}</h1>
        
        <!-- Content Pages -->
        ${contentSections.map(para => {
          if (para.trim().startsWith('PASAL')) {
            return `<h2>${boldQuotedText(para.replace(/\n/g, '<br>'))}</h2>`;
          } else {
            return `<p>${boldQuotedText(para.replace(/\n/g, '<br>'))}</p>`;
          }
        }).join('')}
        
        <div class="spacer"></div>
        <hr>
        
        <div style="margin-top: 40px; page-break-before: always;">
          <table style="width: 100%; border: 2px solid #000; border-collapse: collapse;">
            <tr>
              <td style="width: 50%; padding: 40px 30px; border-right: 2px solid #000; vertical-align: top;">
                <p style="margin: 0 0 100px 0; font-weight: 700; font-size: 16px;"><strong>PIHAK PERTAMA</strong></p>
                <hr style="border: none; border-bottom: 2px solid #000; margin: 0 0 8px 0;">
                <p style="margin: 0; font-size: 14px;">Nama:</p>
              </td>
              <td style="width: 50%; padding: 40px 30px; vertical-align: top;">
                <p style="margin: 0 0 100px 0; font-weight: 700; font-size: 16px;"><strong>PIHAK KEDUA</strong></p>
                <hr style="border: none; border-bottom: 2px solid #000; margin: 0 0 8px 0;">
                <p style="margin: 0; font-size: 14px;">Nama:</p>
              </td>
            </tr>
          </table>
        </div>
      </div>
    </body>
    </html>
  `;
  
  // Create blob and download
  const blob = new Blob(['\ufeff', htmlContent], {
    type: 'application/msword'
  });
  
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = 'Perjanjian_Kerja_Sama_Usaha.doc';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
  const form = document.getElementById('documentForm');
  const preview = document.getElementById('documentPreview');
  
  if (!form || !preview) return;
  
  // Update preview and progress on input
  form.addEventListener('input', () => {
    const formData = collectFormData();
    generatePreview(formData);
    updateProgress();
  });
  
  // Add focus event listeners to all form fields for auto-scroll
  const formFields = form.querySelectorAll('input, textarea, select');
  formFields.forEach(field => {
    field.addEventListener('focus', () => {
      scrollToPreviewSection(field.name || field.id);
    });
  });
  
  // Handle form submission
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = collectFormData();
    
    // Show loading overlay
    const loader = document.getElementById('downloadLoader');
    if (loader) {
      loader.classList.add('is-visible');
    }
    
    // Disable button
    const generateBtn = document.getElementById('generateBtn');
    generateBtn.disabled = true;
    generateBtn.textContent = 'Processing...';
    
    // Wait 1.2 seconds for processing animation
    setTimeout(() => {
      try {
        // Show success state
        const spinner = document.getElementById('loaderSpinner');
        const success = document.getElementById('loaderSuccess');
        const loaderText = document.getElementById('loaderText');
        
        if (spinner) spinner.style.display = 'none';
        if (success) success.style.display = 'block';
        if (loaderText) loaderText.textContent = 'Dokumen siap diunduh!';
        
        // Generate document after success animation
        setTimeout(() => {
          generateWordDocument(formData);
          
          // Hide loader after download starts
          setTimeout(() => {
            if (loader) {
              loader.classList.remove('is-visible');
            }
            // Reset loader state
            if (spinner) spinner.style.display = 'block';
            if (success) success.style.display = 'none';
            if (loaderText) loaderText.textContent = 'Memproses dokumen Anda...';
            
            generateBtn.disabled = false;
            generateBtn.textContent = 'Generate & Download Dokumen';
          }, 800);
        }, 600);
      } catch (error) {
        console.error('Error generating document:', error);
        if (loader) {
          loader.classList.remove('is-visible');
        }
        generateBtn.disabled = false;
        generateBtn.textContent = 'Generate & Download Dokumen';
        alert('Terjadi kesalahan saat membuat dokumen. Silakan coba lagi.');
      }
    }, 1200);
  });
  
  // Initial preview and progress
  generatePreview({});
  updateProgress();
});

