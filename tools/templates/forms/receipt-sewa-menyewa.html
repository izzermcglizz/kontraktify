<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Receipt Pembayaran - Kontraktify</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet"/>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      
      body {
        font-family: 'Poppins', system-ui, sans-serif;
        background: #f5f5f5;
        color: #0f0f10;
        line-height: 1.6;
        padding: 40px 20px;
        min-height: 100vh;
      }
      
      .receipt-container {
        max-width: 600px;
        margin: 0 auto;
        background: #fff;
        border-radius: 16px;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
        overflow: hidden;
      }
      
      .receipt-header {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: #fff;
        padding: 40px 32px;
        text-align: center;
      }
      
      .receipt-header .success-icon {
        width: 64px;
        height: 64px;
        margin: 0 auto 16px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 32px;
      }
      
      .receipt-header h1 {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 8px;
      }
      
      .receipt-header p {
        font-size: 0.875rem;
        opacity: 0.9;
      }
      
      .receipt-content {
        padding: 32px;
      }
      
      .receipt-section {
        margin-bottom: 24px;
        padding-bottom: 24px;
        border-bottom: 1px solid rgba(15, 15, 16, 0.08);
      }
      
      .receipt-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
      }
      
      .receipt-section-title {
        font-size: 0.875rem;
        font-weight: 500;
        color: rgba(15, 15, 16, 0.6);
        margin-bottom: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      .receipt-item {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 12px;
      }
      
      .receipt-item:last-child {
        margin-bottom: 0;
      }
      
      .receipt-item-label {
        font-size: 0.875rem;
        color: rgba(15, 15, 16, 0.7);
        flex: 1;
      }
      
      .receipt-item-value {
        font-size: 0.875rem;
        font-weight: 500;
        color: #0f0f10;
        text-align: right;
        flex: 1;
      }
      
      .receipt-total {
        background: rgba(16, 185, 129, 0.05);
        padding: 20px;
        border-radius: 12px;
        margin-top: 24px;
      }
      
      .receipt-total .receipt-item {
        margin-bottom: 8px;
      }
      
      .receipt-total .receipt-item-value {
        font-size: 1.25rem;
        font-weight: 600;
        color: #10b981;
      }
      
      .receipt-actions {
        padding: 32px;
        background: #f9fafb;
        display: flex;
        gap: 12px;
      }
      
      .btn {
        flex: 1;
        padding: 14px 24px;
        border: none;
        border-radius: 10px;
        font-size: 0.875rem;
        font-weight: 500;
        font-family: 'Poppins', system-ui, sans-serif;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }
      
      .btn--primary {
        background: #10b981;
        color: #fff;
      }
      
      .btn--primary:hover {
        background: #059669;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
      }
      
      .btn--ghost {
        background: #fff;
        color: #0f0f10;
        border: 1px solid rgba(15, 15, 16, 0.1);
      }
      
      .btn--ghost:hover {
        background: rgba(15, 15, 16, 0.03);
        border-color: rgba(15, 15, 16, 0.2);
      }
      
      .receipt-note {
        padding: 16px;
        background: rgba(16, 185, 129, 0.05);
        border-left: 3px solid #10b981;
        border-radius: 8px;
        margin-top: 24px;
        font-size: 0.8125rem;
        color: rgba(15, 15, 16, 0.7);
        line-height: 1.6;
      }
      
      .receipt-note strong {
        color: #10b981;
        font-weight: 600;
      }
      
      @media (max-width: 640px) {
        .receipt-container {
          border-radius: 0;
        }
        
        .receipt-header {
          padding: 32px 24px;
        }
        
        .receipt-content {
          padding: 24px;
        }
        
        .receipt-actions {
          flex-direction: column;
          padding: 24px;
        }
      }
    </style>
  </head>
  <body>
    <div class="receipt-container">
      <div class="receipt-header">
        <div class="success-icon">✓</div>
        <h1>Pembayaran Berhasil!</h1>
        <p>Terima kasih atas pembayaran Anda</p>
      </div>
      
      <div class="receipt-content">
        <div class="receipt-section">
          <div class="receipt-section-title">Detail Pembayaran</div>
          <div class="receipt-item">
            <span class="receipt-item-label">Reference ID</span>
            <span class="receipt-item-value" id="referenceId">-</span>
          </div>
          <div class="receipt-item">
            <span class="receipt-item-label">Metode Pembayaran</span>
            <span class="receipt-item-value" id="paymentMethod">QRIS</span>
          </div>
          <div class="receipt-item">
            <span class="receipt-item-label">Tanggal Pembayaran</span>
            <span class="receipt-item-value" id="paymentDate">-</span>
          </div>
        </div>
        
        <div class="receipt-section">
          <div class="receipt-section-title">Detail Pesanan</div>
          <div class="receipt-item">
            <span class="receipt-item-label">Dokumen</span>
            <span class="receipt-item-value">Perjanjian Sewa Menyewa Tempat</span>
          </div>
        </div>
        
        <div class="receipt-total">
          <div class="receipt-item">
            <span class="receipt-item-label">Total Pembayaran</span>
            <span class="receipt-item-value" id="totalAmount">Rp 0</span>
          </div>
        </div>
        
        <div class="receipt-note">
          <strong>Catatan:</strong> Dokumen Anda akan tersedia untuk diunduh setelah pembayaran dikonfirmasi. Silakan klik tombol "Download Dokumen" di bawah untuk mengunduh dokumen Anda.
        </div>
      </div>
      
      <div class="receipt-actions">
        <a href="preview-sewa-menyewa.html" class="btn btn--ghost">Kembali</a>
        <button class="btn btn--primary" id="downloadBtn">Download Dokumen</button>
      </div>
    </div>
    
    <script src="payment.js"></script>
    <script src="formsewamenyewa.js"></script>
    <script src="../../shared/utils/email.js"></script>
    <script>
      // Generate secure download token
      function generateDownloadToken(referenceId) {
        const timestamp = Date.now();
        const randomStr = Math.random().toString(36).substr(2, 9).toUpperCase();
        return `${referenceId}-${timestamp}-${randomStr}`;
      }
      
      // Load payment info from URL params or sessionStorage
      document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const referenceId = urlParams.get('referenceId') || urlParams.get('ref');
        const status = urlParams.get('status');
        const trxId = urlParams.get('trx_id'); // iPaymu transaction ID
        
        console.log('Receipt page loaded with params:', {
          referenceId,
          status,
          trxId
        });
        
        // Get payment info from sessionStorage
        const paymentInfo = sessionStorage.getItem('paymentInfo');
        const pendingDocument = sessionStorage.getItem('pendingDocument');
        
        let receiptData = {};
        
        if (paymentInfo) {
          try {
            receiptData = JSON.parse(paymentInfo);
            console.log('Payment info from sessionStorage:', receiptData);
          } catch (error) {
            console.error('Error parsing payment info:', error);
          }
        }
        
        if (pendingDocument) {
          try {
            const docData = JSON.parse(pendingDocument);
            if (docData.referenceId) {
              receiptData.referenceId = docData.referenceId;
            }
          } catch (error) {
            console.error('Error parsing pending document:', error);
          }
        }
        
        // Priority: URL param > sessionStorage > default
        const finalReferenceId = referenceId || receiptData.referenceId || trxId || 'N/A';
        document.getElementById('referenceId').textContent = finalReferenceId;
        
        // Update payment method (iPaymu doesn't send this in returnUrl, so we use default)
        const paymentMethod = receiptData.method || 'iPaymu';
        document.getElementById('paymentMethod').textContent = paymentMethod;
        
        // Update amount
        const amount = receiptData.amount || 10000; // Default to test price
        document.getElementById('totalAmount').textContent = `Rp ${amount.toLocaleString('id-ID')}`;
        
        // Set payment date
        const now = new Date();
        const paymentDate = now.toLocaleDateString('id-ID', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
        document.getElementById('paymentDate').textContent = paymentDate;
        
        // If status is provided, update receipt header accordingly
        if (status === 'pending' || status === 'waiting') {
          const header = document.querySelector('.receipt-header');
          if (header) {
            header.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
            header.querySelector('h1').textContent = 'Menunggu Pembayaran';
            header.querySelector('p').textContent = 'Silakan selesaikan pembayaran Anda';
          }
        } else if (status === 'failed' || status === 'cancel') {
          const header = document.querySelector('.receipt-header');
          if (header) {
            header.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
            header.querySelector('h1').textContent = 'Pembayaran Gagal';
            header.querySelector('p').textContent = 'Silakan coba lagi atau hubungi support';
          }
        }
        
        // Send receipt email after payment success
        // Check if payment is successful (status success or no status means success from iPaymu)
        const isPaymentSuccess = !status || status === 'success' || status === 'paid';
        
        if (isPaymentSuccess && finalReferenceId && finalReferenceId !== 'N/A') {
          // Get user email from form data
          const previewData = sessionStorage.getItem('previewDocumentData');
          let userEmail = null;
          let userName = 'Customer';
          
          if (previewData) {
            try {
              const formData = JSON.parse(previewData);
              // Try to get email from buyer object or form data
              userEmail = formData.buyer?.email || formData.email || formData.email_penyewa || null;
              userName = formData.buyer?.name || formData.nama_penyewa || formData.nama || userName;
            } catch (error) {
              console.error('Error parsing form data for email:', error);
            }
          }
          
          // Send receipt email (async, don't block UI)
          if (typeof sendReceiptEmail === 'function' && userEmail && userEmail !== 'customer@example.com') {
            sendReceiptEmail({
              to: userEmail,
              name: userName,
              referenceId: finalReferenceId,
              amount: amount,
              paymentMethod: paymentMethod,
              paymentDate: paymentDate
            }).then(result => {
              if (result.success) {
                console.log('✅ Receipt email sent successfully to', userEmail);
              } else {
                console.warn('⚠️ Failed to send receipt email:', result.error);
              }
            }).catch(error => {
              console.error('Error sending receipt email:', error);
            });
          } else {
            console.log('Email not sent - user email not available or invalid');
          }
        }
        
        // Handle download button
        const downloadBtn = document.getElementById('downloadBtn');
        if (downloadBtn) {
          downloadBtn.addEventListener('click', async () => {
            // Get form data from sessionStorage
            const previewData = sessionStorage.getItem('previewDocumentData');
            if (!previewData) {
              alert('Data dokumen tidak ditemukan. Silakan isi form kembali.');
              window.location.href = 'formsewamenyewa.html';
              return;
            }
            
            try {
              const formData = JSON.parse(previewData);
              
              // Check if payment is confirmed
              const paymentStatus = sessionStorage.getItem('paymentStatus');
              const paymentInfo = sessionStorage.getItem('paymentInfo');
              
              if (paymentStatus !== 'paid' && paymentInfo) {
                // Try to check payment status
                const paymentInfoObj = JSON.parse(paymentInfo);
                if (paymentInfoObj.status !== 'paid') {
                  // Payment not confirmed yet
                  if (confirm('Pembayaran belum dikonfirmasi. Apakah Anda yakin sudah membayar? Jika ya, kami akan memeriksa status pembayaran Anda.')) {
                    if (typeof checkPaymentStatus === 'function' && paymentInfoObj.referenceId) {
                      const statusResult = await checkPaymentStatus(paymentInfoObj.referenceId);
                      if (statusResult.success && statusResult.isPaid) {
                        sessionStorage.setItem('paymentStatus', 'paid');
                        // Continue to download
                      } else {
                        alert('Pembayaran belum dikonfirmasi. Silakan selesaikan pembayaran terlebih dahulu atau hubungi support jika Anda sudah membayar.');
                        return;
                      }
                    } else {
                      alert('Tidak dapat memverifikasi pembayaran. Silakan hubungi support.');
                      return;
                    }
                  } else {
                    return;
                  }
                }
              }
              
              // Generate download link
              const downloadToken = generateDownloadToken(receiptData.referenceId);
              const downloadLink = `${window.location.origin}/tools/templates/forms/download-sewa-menyewa.html?token=${downloadToken}&ref=${receiptData.referenceId}`;
              
              // Store download link in sessionStorage
              sessionStorage.setItem('downloadLink', downloadLink);
              sessionStorage.setItem('downloadToken', downloadToken);
              
              // Get user email for sending download link
              const userEmail = formData.email || formData.email_penyewa || null;
              const userName = formData.nama_penyewa || formData.nama || 'Customer';
              
              // Generate and download document
              if (typeof downloadDocument === 'function') {
                downloadDocument(formData);
                
                // Send download link email (async, don't block download)
                if (typeof sendDownloadLinkEmail === 'function' && userEmail && userEmail !== 'customer@example.com') {
                  sendDownloadLinkEmail({
                    to: userEmail,
                    name: userName,
                    downloadLink: downloadLink,
                    documentName: 'Perjanjian Sewa Menyewa Tempat',
                    referenceId: receiptData.referenceId
                  }).then(result => {
                    if (result.success) {
                      console.log('✅ Download link email sent successfully');
                    } else {
                      console.warn('⚠️ Failed to send download link email:', result.error);
                    }
                  }).catch(error => {
                    console.error('Error sending download link email:', error);
                  });
                }
              } else {
                alert('Fungsi download tidak tersedia. Silakan hubungi support.');
              }
            } catch (error) {
              console.error('Error loading form data:', error);
              alert('Terjadi kesalahan saat memuat data dokumen.');
            }
          });
        }
      });
    </script>
  </body>
</html>

